<html>
<head>
	<title>TarotClub deal viewer</title>
        <style media="screen">
        body {
            background: #030 url("bg.png");
        }
        </style>

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<script type="text/javascript" src="system.js"></script>
	<script type="text/javascript" src="../../assets/ai/tarotlib/util.js"></script>
	<script type="text/javascript" src="../../assets/ai/tarotlib/card.js"></script>
	<script type="text/javascript" src="../../assets/ai/tarotlib/deck.js"></script>
	
	<script type="text/javascript" src="jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="jquery-ui.min.js"></script>
	<script type="text/javascript" src="snap.svg-min.js"></script>
	
<script type="text/javascript">
	
	var dealFile;
	var snap;
	
	function init() 
    {
		snap = Snap("#svg");
		
		CreateTarotDeck(snap);

		var dropzone = document.getElementById("dropzone");
		dropzone.ondragover = dropzone.ondragenter = function(event)
		{
			event.stopPropagation();
			event.preventDefault();
		}
    
		dropzone.ondrop = function(event)
		{
			event.stopPropagation();
			event.preventDefault();

			var filesArray = event.dataTransfer.files;
			
			if (filesArray.length > 0)
			{
				DisplayDeal(filesArray[0]);
			}
		}	
	}
	
	function DisplayDeal(file)
	{
		var reader = new FileReader();
		reader.onload = function() {
			//alert('File contents:\n\n' + reader.result);
			var deal;
			try {
				deal = JSON.parse(reader.result);
			} catch (e) {
				console.error("Parsing error:", e); 
				alert('Parsing error');
				deal = undefined;
			}
			
			if (deal != undefined)
			{
				var x = 0;
				var y = 0;
				for (var i = 0; i < deal.tricks.length; i++) {
					var deck = new TarotLib.Deck();
					deck.setCards(deal.tricks[i]);
					
					for (var j = 0; j < deck.size(); j++) {
						var card = deck.get(j);
						g = snap.select("#c" + card.getName());
						g.attr({
							transform: "translate(" + x + ", " + y + ")"
						});
						
						x += 65;
					}
					x = 0;
					y += 115;
				}
			}
		};
		reader.readAsText(file);
	}
	
	function CreateTarotDeck(snap)
	{
		var deck = new TarotLib.Deck();
		deck.makeTarotDeck();
		
		var x = 0;
		var y = 0;
		for (var i = 0; i < deck.size(); i++)
		{
			var card = deck.get(i);
			var cardSvg = snap.select("#c" + card.getName());
			cardSvg.attr({
				transform: "translate(" + x + ", " + y + ")"
			});
			
			var limit = 14;
			if (card.suit == "T")
			{
				limit = 13;
			}
			
			if (card.value == limit)
			{
				x = 0;
				y += 115;
			}
			else
			{
				x += 65;
			}
		}
	}
 
</script>


</head>

<body onload="init()">
	
	<div>
        <div id="dropzone" style="margin:30px; width:500px; height:100px; border:4px dotted grey;">Drag & drop your deal file here...</div>
    </div>
	
	<object type="image/svg+xml" data="../../assets/cards/minideck.svg" />
	
</body>
</html>
 
